# coding=UTF-8
# ex:ts=4:sw=4:et=on

import os
import logging
logger = logging.getLogger(__name__)

from PySide6.QtWidgets import QFileDialog


def _retrieve_lowercase_extension(glob):
    """'*.[oO][rR][aA]' → '*.ora'"""
    return "".join(
        [c.replace("[", "").replace("]", "")[:-1] for c in glob.split("][")]
    )


def _adjust_filename_to_globs(filename, globs):
    """Append the correct extension if the filename doesn't already have it."""
    if globs:
        for glob in globs:
            if glob is not None:
                extension = glob[1:]
                if filename[len(filename) - len(extension):].lower() != extension.lower():
                    continue
                else:
                    return filename
        # No match found — add extension of first glob
        if globs and globs[0] is not None:
            return "%s%s" % (filename, globs[0][1:])
    return filename


def _build_name_filter(filters):
    """
    Convert a list of (name, globs) tuples or parser-bearing objects into
    a QFileDialog name-filter string list, e.g. ["PNG Files (*.png)", …].
    """
    name_filters = []
    for f in filters:
        try:
            name, globs = f
        except (TypeError, ValueError):
            # Object with parser attribute (parser.description, parser.extensions)
            try:
                parser = f.parser
                name = parser.description
                globs = parser.extensions
            except AttributeError:
                continue
        if isinstance(globs, str):
            globs = [globs]
        pattern = " ".join(globs) if globs else "*"
        name_filters.append("%s (%s)" % (name, pattern))
    return name_filters


class FileDialog:
    """
    Thin wrapper around QFileDialog that mirrors the interface of
    GTK FileChooserDialog.

    Usage::

        dlg = FileDialog(title="Open", action="open", filters=[...])
        dlg.run(on_accept=lambda d: print(d.filename))
    """

    # Responses that count as "accept"
    accept_responses = (QFileDialog.Accepted,)

    def __init__(
        self,
        title="", action="open", parent=None,
        current_name=None, current_folder=None,
        extra_widget=None, filters=None,
        multiple=False, confirm_overwrite=True, persist=False,
        context=None,
    ):
        self.title = title
        self.action = action  # "open" | "save"
        self.parent_widget = parent
        self.current_name = current_name
        self.current_folder = current_folder or os.path.expanduser("~")
        self.filters = list(filters) if filters else []
        self.multiple = multiple
        self.confirm_overwrite = confirm_overwrite
        self.persist = persist

        self._filename = None
        self._filenames = []
        self._parser = None

    @property
    def filename(self):
        return self._filename

    @property
    def filenames(self):
        return self._filenames

    @property
    def parser(self):
        return self._parser

    def update(self, **kwargs):
        for key, value in kwargs.items():
            if hasattr(self, key):
                setattr(self, key, value)
        return self

    def _build_dialog(self):
        dlg = QFileDialog(self.parent_widget, self.title, self.current_folder)
        name_filters = _build_name_filter(self.filters)
        if name_filters:
            dlg.setNameFilters(name_filters)
        if self.action in ("save",):
            dlg.setAcceptMode(QFileDialog.AcceptSave)
            dlg.setFileMode(QFileDialog.AnyFile)
            if self.current_name:
                dlg.selectFile(self.current_name)
        else:
            dlg.setAcceptMode(QFileDialog.AcceptOpen)
            if self.multiple:
                dlg.setFileMode(QFileDialog.ExistingFiles)
            else:
                dlg.setFileMode(QFileDialog.ExistingFile)
        return dlg

    def run(self, on_accept_callback=None, on_reject_callback=None, destroy=True):
        """
        Show the dialog modally. Calls on_accept_callback(self) if accepted,
        on_reject_callback(self) if rejected/cancelled.
        """
        dlg = self._build_dialog()
        if dlg.exec() == QFileDialog.Accepted:
            files = dlg.selectedFiles()
            self._filenames = files
            self._filename = files[0] if files else None
            # Adjust extension if needed
            if self._filename:
                selected_filter = dlg.selectedNameFilter()
                # Extract globs from selected filter, e.g. "PNG Files (*.png)" → ["*.png"]
                import re
                match = re.search(r'\(([^)]+)\)', selected_filter)
                globs = match.group(1).split() if match else []
                self._filename = _adjust_filename_to_globs(self._filename, globs)
            if callable(on_accept_callback):
                on_accept_callback(self)
        else:
            if callable(on_reject_callback):
                on_reject_callback(self)

    pass  # end of class
