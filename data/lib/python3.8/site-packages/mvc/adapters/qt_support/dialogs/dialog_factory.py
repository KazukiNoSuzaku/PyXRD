# coding=UTF-8
# ex:ts=4:sw=4:et=on

import sys
import html
import logging
logger = logging.getLogger(__name__)

from contextlib import contextmanager

from PySide6.QtWidgets import QDialog, QVBoxLayout, QApplication
from PySide6.QtCore import QTimer

from .file_dialog import FileDialog
from .message_dialog import MessageDialog


class DialogFactory:
    """
    Qt replacement for the GTK DialogFactory.
    Static methods mirror the GTK version's API so callers need no changes.
    """

    # ------------------------------------------------------------------
    #  File dialogs
    # ------------------------------------------------------------------

    @staticmethod
    def get_file_dialog_from_context(context, parent=None, **kwargs):
        return FileDialog(context, parent=parent, **kwargs)

    @staticmethod
    def get_file_dialog(
        action, title, parent=None,
        current_name=None, current_folder=None,
        extra_widget=None, filters=None,
        multiple=False, confirm_overwrite=True, persist=False,
    ):
        return FileDialog(
            title=title, action=action, parent=parent,
            current_name=current_name, current_folder=current_folder,
            extra_widget=extra_widget, filters=filters or [],
            multiple=multiple, confirm_overwrite=confirm_overwrite, persist=persist,
        )

    @staticmethod
    def get_save_dialog(
        title, parent=None,
        current_name=None, current_folder=None,
        extra_widget=None, filters=None,
        confirm_overwrite=True, persist=False,
    ):
        return DialogFactory.get_file_dialog(
            action="save", title=title, parent=parent,
            current_name=current_name, current_folder=current_folder,
            extra_widget=extra_widget, filters=filters,
            multiple=False, confirm_overwrite=confirm_overwrite, persist=persist,
        )

    @staticmethod
    def get_load_dialog(
        title, parent=None,
        current_name=None, current_folder=None,
        extra_widget=None, filters=None,
        multiple=True, persist=False,
    ):
        return DialogFactory.get_file_dialog(
            action="open", title=title, parent=parent,
            current_name=current_name, current_folder=current_folder,
            extra_widget=extra_widget, filters=filters,
            multiple=multiple, confirm_overwrite=False, persist=persist,
        )

    # ------------------------------------------------------------------
    #  Message dialogs
    # ------------------------------------------------------------------

    @staticmethod
    def get_message_dialog(
        message, type, buttons="yes_no",  # noqa: A002
        persist=False, parent=None, title=None,
    ):
        return MessageDialog(
            message=message, parent=parent,
            type=type, buttons=buttons,
            persist=persist, title=title,
        )

    @staticmethod
    def get_confirmation_dialog(message, persist=False, parent=None, title=None):
        return DialogFactory.get_message_dialog(
            message, parent=parent, type="warning",
            persist=persist, title=title,
        )

    @staticmethod
    def get_information_dialog(message, persist=False, parent=None, title=None):
        return DialogFactory.get_message_dialog(
            message, parent=parent, type="info", buttons="ok",
            persist=persist, title=title,
        )

    @staticmethod
    def get_error_dialog(message, persist=False, parent=None, title=None):
        return DialogFactory.get_message_dialog(
            message, parent=parent, type="error", buttons="ok",
            persist=persist, title=title,
        )

    # ------------------------------------------------------------------
    #  Custom dialog
    # ------------------------------------------------------------------

    @staticmethod
    def get_custom_dialog(content, parent=None):
        """Wrap a widget in a simple modal QDialog."""
        dlg = QDialog(parent)
        dlg.setModal(True)
        layout = QVBoxLayout(dlg)
        layout.setContentsMargins(10, 10, 10, 10)
        layout.addWidget(content)
        dlg.setLayout(layout)
        return dlg

    # ------------------------------------------------------------------
    #  Error dialog context manager
    # ------------------------------------------------------------------

    @staticmethod
    @contextmanager
    def error_dialog_handler(message, parent=None, title=None, reraise=True, print_tb=True):
        """
        Context manager: if an exception escapes the body, show an error dialog.
        """
        try:
            yield
        except Exception:
            msg = message.format(html.escape("%s" % sys.exc_info()[1]))
            DialogFactory.get_error_dialog(msg, title=title, parent=parent).run()
            if reraise:
                raise
            elif print_tb:
                from traceback import print_exc
                print_exc()

    # ------------------------------------------------------------------
    #  Progress dialog
    # ------------------------------------------------------------------

    @staticmethod
    def get_progress_dialog(
        action, complete_callback=None,
        gui_message="Processing ...", toplevel=None,
    ):
        """
        Returns a callable that, when called, shows a progress dialog and
        runs 'action' in a background thread.

        Mirrors the GTK version's API exactly.
        """
        from mvc.support.cancellable_thread import CancellableThread
        from mvc.support.gui_loop import run_when_idle, add_timeout_call, remove_timeout_call
        from mvc.adapters.qt_support.widgets.threaded_task_box import QtThreadedTaskBox

        def run_action_and_show_progress():
            taskgui = QtThreadedTaskBox()
            window = DialogFactory.get_custom_dialog(taskgui, parent=toplevel)

            status_dict = {}

            def load_task(stop=None):
                action(status_dict)

            def on_interrupted(*args, **kwargs):
                window.hide()

            def gui_callback():
                taskgui.set_status(gui_message.format(**status_dict))
                return True

            add_timeout_call(250, gui_callback)

            @run_when_idle
            def on_complete(*args, **kwargs):
                remove_timeout_call(gui_callback)
                taskgui.stop()
                window.hide()
                window.deleteLater()
                if callable(complete_callback):
                    complete_callback(*args, **kwargs)

            thread = CancellableThread(load_task, on_complete)
            thread.start()

            taskgui.cancelrequested.connect(on_interrupted)
            taskgui.stoprequested.connect(on_interrupted)
            taskgui.set_status("Loading GUI...")
            taskgui.start()
            window.show()

        return run_action_and_show_progress

    pass  # end of class
