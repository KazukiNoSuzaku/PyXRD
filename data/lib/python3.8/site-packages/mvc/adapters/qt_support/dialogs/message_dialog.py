# coding=UTF-8
# ex:ts=4:sw=4:et=on

import logging
logger = logging.getLogger(__name__)

from PySide6.QtWidgets import QMessageBox


# Map GTK MessageType strings / ints → QMessageBox.Icon
_TYPE_MAP = {
    "info":     QMessageBox.Information,
    "warning":  QMessageBox.Warning,
    "error":    QMessageBox.Critical,
    "question": QMessageBox.Question,
    # GTK integer enum fallbacks
    0: QMessageBox.Information,   # Gtk.MessageType.INFO
    1: QMessageBox.Warning,       # Gtk.MessageType.WARNING
    2: QMessageBox.Question,      # Gtk.MessageType.QUESTION
    3: QMessageBox.Critical,      # Gtk.MessageType.ERROR
}

# Map GTK ButtonsType strings / ints → QMessageBox.StandardButtons
_BUTTONS_MAP = {
    "none":      QMessageBox.NoButton,
    "ok":        QMessageBox.Ok,
    "close":     QMessageBox.Close,
    "cancel":    QMessageBox.Cancel,
    "yes_no":    QMessageBox.Yes | QMessageBox.No,
    "ok_cancel": QMessageBox.Ok | QMessageBox.Cancel,
    # GTK integer enum fallbacks
    0: QMessageBox.NoButton,
    1: QMessageBox.Ok,
    2: QMessageBox.Close,
    3: QMessageBox.Cancel,
    4: QMessageBox.Yes | QMessageBox.No,
    5: QMessageBox.Ok | QMessageBox.Cancel,
}

_ACCEPT_BUTTONS = {QMessageBox.Ok, QMessageBox.Yes, QMessageBox.Apply}


class MessageDialog:
    """
    Thin wrapper around QMessageBox that mirrors the interface of the
    GTK MessageDialog wrapper.

    Usage::

        dlg = MessageDialog("Are you sure?", type="question")
        dlg.run(on_accept=lambda d: do_it(), on_reject=lambda d: cancel())
    """

    accept_responses = tuple(_ACCEPT_BUTTONS)

    def __init__(
        self,
        message="", parent=None,
        type="info",       # noqa: A002  (shadowing built-in intentionally)
        buttons="yes_no",
        persist=False,
        title=None,
        flags=None,        # ignored; GTK compat
    ):
        self.message = message
        self.parent_widget = parent
        self.msg_type = type
        self.buttons = buttons
        self.persist = persist
        self.title = title

    def run(self, on_accept_callback=None, on_reject_callback=None, destroy=True):
        """Show dialog modally and call the appropriate callback."""
        icon = _TYPE_MAP.get(self.msg_type, QMessageBox.Information)
        std_buttons = _BUTTONS_MAP.get(self.buttons, QMessageBox.Ok)

        box = QMessageBox(self.parent_widget)
        box.setIcon(icon)
        box.setStandardButtons(std_buttons)
        if self.title:
            box.setWindowTitle(self.title)
        # Render markup as HTML in Qt
        box.setText(self.message)
        box.setTextFormat(2)  # Qt.RichText

        result = box.exec()

        if result in _ACCEPT_BUTTONS and callable(on_accept_callback):
            on_accept_callback(self)
        elif result not in _ACCEPT_BUTTONS and callable(on_reject_callback):
            on_reject_callback(self)

    pass  # end of class
