# coding=UTF-8
# ex:ts=4:sw=4:et=on

import weakref
import logging
logger = logging.getLogger(__name__)

from PySide6.QtCore import QAbstractItemModel, QModelIndex, Qt, Signal


class BaseQtObjectListModel(QAbstractItemModel):
    """
    Base QAbstractItemModel for lists/trees of mvc model objects.
    Maps object properties to table columns.
    Mirrors the interface of BaseObjectListStore (GTK GenericTreeModel subclass)
    so that consumers can use either toolkit transparently.
    """

    columns_changed = Signal()

    _columns = None    # list of (name, type) tuples
    _class_type = None

    __weakref_model = None

    @property
    def _model(self):
        if self.__weakref_model is not None:
            return self.__weakref_model()
        return None

    @_model.setter
    def _model(self, value):
        if value is not None:
            self.__weakref_model = weakref.ref(value)
        else:
            self.__weakref_model = None

    def __init__(self, class_type, parent=None):
        super().__init__(parent)
        if class_type is None:
            raise ValueError(
                "Invalid class_type for %s! Expecting object, but None was given" % type(self)
            )
        elif not hasattr(class_type, "Meta"):
            raise ValueError(
                "Invalid class_type for `%s`! `%s` does not have a `Meta` attribute!"
                % (type(self), class_type)
            )
        elif not hasattr(class_type.Meta, "get_column_properties"):
            raise ValueError(
                "Invalid class_type for %s! %s.Meta does not have get_column_properties method!"
                % (type(self), class_type)
            )
        self._setup_class_type(class_type)

    def _setup_class_type(self, class_type):
        self._class_type = class_type
        self._columns = []
        for title, col_type in class_type.Meta.get_column_properties():
            if isinstance(col_type, str):
                col_type = str
            self._columns.append((title, col_type))
        for i, col in enumerate(self._columns):
            setattr(self, "c_%s" % col[0], i)

    def is_wrapping(self, model, prop_name):
        raise NotImplementedError

    def get_objects(self):
        raise NotImplementedError

    def iter_objects(self):
        raise NotImplementedError

    # --- QAbstractItemModel required overrides ---

    def columnCount(self, parent=QModelIndex()):
        return len(self._columns) if self._columns else 0

    def headerData(self, section, orientation, role=Qt.DisplayRole):
        if orientation == Qt.Horizontal and role == Qt.DisplayRole:
            if self._columns and 0 <= section < len(self._columns):
                return self._columns[section][0]
        return None

    def flags(self, index):
        if not index.isValid():
            return Qt.NoItemFlags
        return Qt.ItemIsEnabled | Qt.ItemIsSelectable

    pass  # end of class
