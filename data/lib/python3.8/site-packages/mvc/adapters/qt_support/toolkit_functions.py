# coding=UTF-8
# ex:ts=4:sw=4:et=on

from PySide6.QtCore import QTimer
from PySide6.QtWidgets import QApplication

_timers = {}  # source_id -> QTimer, to support remove_source

def add_idle_call(func, *args):
    """Schedule func(*args) to run as soon as the event loop is idle."""
    timer = QTimer()
    timer.setSingleShot(True)
    timer.timeout.connect(lambda: func(*args))
    timer.start(0)
    _timers[id(timer)] = timer
    return timer

def remove_source(source):
    """Stop and discard a timer returned by add_idle_call or add_timeout_call."""
    if source is not None:
        source.stop()
        _timers.pop(id(source), None)

def add_timeout_call(timeout, func, *args):
    """Schedule func(*args) to run repeatedly every *timeout* milliseconds."""
    timer = QTimer()
    timer.timeout.connect(lambda: func(*args))
    timer.start(timeout)
    _timers[id(timer)] = timer
    return timer

def start_event_loop():
    app = QApplication.instance()
    if app is None:
        raise RuntimeError("QApplication must be created before starting the event loop")
    return app.exec()

def stop_event_loop():
    app = QApplication.instance()
    if app is not None:
        app.quit()
