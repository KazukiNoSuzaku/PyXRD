# coding=UTF-8
# ex:ts=4:sw=4:et=on

# Originally based on gtkexcepthook by Gustavo J A M Carneiro (2003)
# and Filip Van Raemdonck (2004-2005).
# Adapted for PySide6 by the PyXRD port.

import inspect, linecache, pydoc, sys, traceback
from io import StringIO
from gettext import gettext as _

from PySide6.QtWidgets import (
    QDialog, QVBoxLayout, QHBoxLayout,
    QLabel, QTextEdit, QPushButton, QApplication,
)
from PySide6.QtGui import QFont
from PySide6.QtCore import Qt

original_excepthook = sys.excepthook


class QtExceptionHook:
    """
    Exception handling Qt-dialog hook.
    Drop-in replacement for GtkExceptionHook â€” same public API.
    """

    quit_confirmation_func = None
    exception_dialog_active = False
    RESPONSE_QUIT = 1

    _parent_window = [None]
    _level = 0

    @property
    def parent_window(self):
        return self._parent_window[self._level]

    @parent_window.setter
    def parent_window(self, value):
        self._parent_window[self._level] = value

    def overriden_parent_window(self, parent):
        self._parent_window.append(parent)
        self._level = len(self._parent_window) - 1
        return self

    def __enter__(self):
        pass

    def __exit__(self, *args):
        if self._level > 0:
            self._parent_window.pop()
            self._level = max(0, len(self._parent_window) - 1)

    def analyze_simple(self, exctyp, value, tb):
        trace = StringIO()
        traceback.print_exception(exctyp, value, tb, None, trace)
        return trace

    def __call__(self, exctyp, value, tb):
        if exctyp is KeyboardInterrupt:
            return original_excepthook(exctyp, value, tb)

        sys.stderr.write(self.analyze_simple(exctyp, value, tb).getvalue())

        if self.exception_dialog_active:
            return

        self.exception_dialog_active = True

        try:
            trace = self.analyze_simple(exctyp, value, tb).getvalue()
        except Exception:
            trace = _("Exception while analyzing the exception.")

        dlg = QDialog(self.parent_window)
        dlg.setWindowTitle(_("Bug Detected"))
        dlg.setModal(True)
        dlg.resize(800, 500)

        layout = QVBoxLayout(dlg)

        header = QLabel(
            _("<big><b>A programming error has been detected.</b></big>")
        )
        header.setTextFormat(Qt.RichText)
        layout.addWidget(header)

        secondary = QLabel(
            _("It probably isn't fatal, but the details should be reported "
              "to the developers nonetheless.")
        )
        secondary.setWordWrap(True)
        layout.addWidget(secondary)

        text_edit = QTextEdit()
        text_edit.setReadOnly(True)
        mono = QFont("Courier")
        mono.setStyleHint(QFont.TypeWriter)
        text_edit.setFont(mono)
        text_edit.setPlainText(trace)
        layout.addWidget(text_edit)

        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        close_btn = QPushButton(_("Close"))
        quit_btn  = QPushButton(_("Quit"))
        btn_layout.addWidget(close_btn)
        btn_layout.addWidget(quit_btn)
        layout.addLayout(btn_layout)

        def on_close():
            dlg.accept()
            self.exception_dialog_active = False

        def on_quit():
            if not callable(self.quit_confirmation_func):
                sys.exit(1)
            else:
                if self.quit_confirmation_func():
                    sys.exit(1)
                else:
                    dlg.accept()
                    self.exception_dialog_active = False

        close_btn.clicked.connect(on_close)
        quit_btn.clicked.connect(on_quit)

        dlg.exec()

    def _dialog_response_cb(self, *args):
        pass  # kept for API compatibility


# Keep the GTK class name as an alias so existing imports still work
GtkExceptionHook = QtExceptionHook


def plugin_gtk_exception_hook():
    hook = QtExceptionHook()
    sys.excepthook = hook
    return hook
