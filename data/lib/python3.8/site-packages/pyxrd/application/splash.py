# coding=UTF-8
# ex:ts=4:sw=4:et=on

# Copyright (c) 2013, Mathijs Dumon
# All rights reserved.
# Complete license can be found in the LICENSE file.

from time import time, sleep

from PySide6.QtWidgets import QWidget, QVBoxLayout, QLabel, QApplication
from PySide6.QtGui import QPixmap
from PySide6.QtCore import Qt, QTimer

from pyxrd.application.icons import get_icon_list


def scale_ratio(src_width, src_height, dest_width, dest_height):
    """Return a size fitting into dest preserving src's aspect ratio."""
    if src_height > dest_height:
        if src_width > dest_width:
            ratio = min(float(dest_width) / src_width,
                        float(dest_height) / src_height)
        else:
            ratio = float(dest_height) / src_height
    elif src_width > dest_width:
        ratio = float(dest_width) / src_width
    else:
        ratio = 1
    return int(ratio * src_width), int(ratio * src_height)


class ScalableImage(QLabel):
    """
    A QLabel that rescales its pixmap to fit whatever size is allocated.
    Replaces ScalableImage(Gtk.Image).
    """

    def __init__(self, pixbuf=None, parent=None):
        super().__init__(parent)
        self._pixmap = None
        self._hyper_timer = QTimer(self)
        self._hyper_timer.setSingleShot(True)
        self._hyper_timer.timeout.connect(self._on_timeout_hyper)
        self.setMinimumSize(1, 1)
        self.setAlignment(Qt.AlignCenter)
        if pixbuf is not None:
            self.set_from_pixbuf(pixbuf)

    def _on_timeout_hyper(self):
        if self._pixmap is None:
            return
        w, h = scale_ratio(
            self._pixmap.width(), self._pixmap.height(),
            self.width(), self.height()
        )
        if w > 0 and h > 0:
            scaled = self._pixmap.scaled(w, h, Qt.KeepAspectRatio, Qt.SmoothTransformation)
            super().setPixmap(scaled)

    def resizeEvent(self, event):
        super().resizeEvent(event)
        self._rescale(force=False)

    def _rescale(self, force=False):
        if self._pixmap is None:
            return
        pix_w, pix_h = self._pixmap.width(), self._pixmap.height()
        target_w, target_h = scale_ratio(pix_w, pix_h, self.width(), self.height())
        if target_w < pix_w or target_h < pix_h:
            if target_w > 0 and target_h > 0:
                mode = Qt.SmoothTransformation if force else Qt.FastTransformation
                quick = self._pixmap.scaled(target_w, target_h, Qt.KeepAspectRatio, mode)
                super().setPixmap(quick)
                if not force:
                    self._hyper_timer.start(100)
        else:
            super().setPixmap(self._pixmap)

    def set_from_file(self, filename):
        self.set_from_pixbuf(QPixmap(filename))

    def set_from_pixbuf(self, pixmap):
        self._pixmap = pixmap
        self._rescale(force=True)


class SplashScreen(object):
    """
    Frameless Qt splash window shown while PyXRD loads.
    Replaces the GTK SplashScreen.
    """

    def __init__(self, filename, version=""):
        self.window = QWidget(None, Qt.SplashScreen | Qt.FramelessWindowHint)
        self.window.setWindowTitle("PyXRD")
        self.window.setWindowIcon(get_icon_list())
        self.window.setStyleSheet("background-color: white;")

        layout = QVBoxLayout(self.window)
        layout.setContentsMargins(10, 10, 10, 10)
        layout.setSpacing(1)

        self.img = ScalableImage()
        self.img.set_from_file(filename)
        self.img.setMinimumSize(500, 300)
        layout.addWidget(self.img, stretch=1)

        self.lbl = QLabel("<span style='font-size:larger; font-weight:bold;'>Loading ...</span>")
        self.lbl.setAlignment(Qt.AlignCenter)
        self.lbl.setTextFormat(Qt.RichText)
        layout.addWidget(self.lbl)

        self.version_lbl = QLabel("<i>Version %s</i>" % version)
        self.version_lbl.setAlignment(Qt.AlignCenter)
        self.version_lbl.setTextFormat(Qt.RichText)
        layout.addWidget(self.version_lbl)

        self.window.show()
        QApplication.processEvents()
        self.start_time = time()
        self.closed = False

    def set_message(self, message):
        self.lbl.setText(
            "<span style='font-size:larger; font-weight:bold;'>%s</span>" % message
        )
        QApplication.processEvents()

    def close(self):
        if not self.closed:
            while max(5 - (time() - self.start_time), 0) != 0:
                sleep(0.1)
                QApplication.processEvents()
            self.window.hide()
            self.window.deleteLater()
            del self.window, self.lbl, self.img, self.version_lbl
            self.closed = True

    pass  # end of class
